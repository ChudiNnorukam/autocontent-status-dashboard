<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Autoposter Command Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light dark;
        --bg: radial-gradient(circle at top left, #1e293b 0%, #020617 45%, #000510 100%);
        --panel: rgba(15, 23, 42, 0.78);
        --panel-strong: rgba(15, 23, 42, 0.92);
        --panel-border: rgba(148, 163, 184, 0.14);
        --text: #f8fafc;
        --text-muted: rgba(203, 213, 225, 0.85);
        --accent: #38bdf8;
        --accent-strong: #0ea5e9;
        --accent-soft: rgba(56, 189, 248, 0.18);
        --warning: #f97316;
        --danger: #f87171;
        --success: #22c55e;
        --panel-glow: 0 40px 80px rgba(15, 23, 42, 0.55);
        --font-sans: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        color: var(--text);
        display: flex;
        justify-content: center;
        font-family: var(--font-sans);
        transition: background 0.6s ease, color 0.6s ease;
        overflow-x: hidden;
      }

      body[data-theme="light"] {
        color-scheme: light;
        --bg: radial-gradient(circle at top left, #f8fafc 0%, #e2e8f0 45%, #cbd5f5 100%);
        --panel: rgba(255, 255, 255, 0.82);
        --panel-strong: rgba(255, 255, 255, 0.94);
        --panel-border: rgba(148, 163, 184, 0.2);
        --text: #0f172a;
        --text-muted: rgba(51, 65, 85, 0.72);
        --accent: #0ea5e9;
        --accent-strong: #0284c7;
        --accent-soft: rgba(14, 165, 233, 0.16);
        --warning: #ea580c;
        --danger: #dc2626;
        --success: #16a34a;
        --panel-glow: 0 30px 70px rgba(15, 23, 42, 0.1);
      }

      main {
        width: min(1200px, 94vw);
        padding: 4rem 0 6rem 0;
      }

      header {
        display: flex;
        flex-direction: column;
        gap: 0.9rem;
        margin-bottom: 2.5rem;
        position: relative;
      }

      header::after {
        content: "";
        position: absolute;
        inset: -40% auto auto -20%;
        width: 420px;
        height: 420px;
        background: radial-gradient(circle, rgba(14, 165, 233, 0.28) 0%, rgba(2, 6, 23, 0) 70%);
        filter: blur(20px);
        pointer-events: none;
        z-index: -1;
      }

      .header-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .theme-toggle {
        border: none;
        padding: 0.48rem 1.05rem;
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--accent);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        font-size: 0.75rem;
        cursor: pointer;
        transition: transform 0.25s ease, background 0.3s ease, color 0.3s ease;
      }

      .theme-toggle:hover {
        transform: translateY(-1px);
        background: rgba(56, 189, 248, 0.24);
      }

      .theme-toggle:focus-visible,
      .ghost-button:focus-visible,
      .copy-btn:focus-visible {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }

      .pill {
        align-self: flex-start;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.45rem 0.9rem;
        border-radius: 999px;
        background: rgba(14, 165, 233, 0.12);
        border: 1px solid rgba(56, 189, 248, 0.25);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        font-size: 0.78rem;
        color: var(--accent);
      }

      h1 {
        margin: 0;
        font-size: clamp(2.2rem, 6vw, 3.2rem);
        font-weight: 800;
        letter-spacing: -0.035em;
      }

      .subtitle {
        color: var(--text-muted);
        max-width: 80ch;
        line-height: 1.65;
        font-size: 1.04rem;
      }

      .meta-strip {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      .control-bar {
        display: flex;
        align-items: flex-end;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1.4rem;
      }

      .control-item {
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
      }

      .control-item label {
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        color: rgba(148, 163, 184, 0.82);
      }

      .control-item select {
        background: var(--panel);
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        padding: 0.55rem 0.75rem;
        color: var(--text);
        font-size: 0.95rem;
        box-shadow: var(--panel-glow);
        transition: border 0.2s ease, background 0.2s ease;
      }

      .control-item select:hover {
        border-color: rgba(148, 163, 184, 0.4);
      }

      .ghost-button {
        border: 1px solid var(--panel-border);
        background: transparent;
        color: var(--text-muted);
        border-radius: 12px;
        padding: 0.55rem 1rem;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background 0.25s ease, color 0.25s ease;
      }

      .ghost-button:hover {
        background: rgba(148, 163, 184, 0.12);
        color: var(--text);
      }

      .panel-grid {
        display: grid;
        gap: 1.6rem;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      }

      .panel {
        background: var(--panel);
        border-radius: 22px;
        padding: 1.9rem;
        border: 1px solid var(--panel-border);
        box-shadow: var(--panel-glow);
        backdrop-filter: blur(16px);
      }

      .panel h2 {
        margin: 0 0 0.75rem 0;
        font-size: 1rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.9);
      }

      .stat {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .stat .value {
        font-size: 2.6rem;
        font-weight: 700;
      }

      .stat .caption {
        font-size: 0.95rem;
        color: var(--text-muted);
      }

      .summary-panels {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.4rem;
        margin-bottom: 2.4rem;
      }

      .summary-panels .panel {
        position: relative;
        overflow: hidden;
      }

      .summary-panels .panel::after {
        content: "";
        position: absolute;
        inset: -30% -45% auto auto;
        width: 180px;
        height: 180px;
        background: radial-gradient(circle, rgba(56, 189, 248, 0.16) 0%, rgba(56, 189, 248, 0) 70%);
        pointer-events: none;
      }

      .section-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin: 3rem 0 1.4rem 0;
      }

      .section-title h3 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 700;
        letter-spacing: -0.01em;
      }

      .section-title span {
        color: var(--text-muted);
        font-size: 0.95rem;
      }

      .two-column {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.6rem;
      }

      .list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 1.1rem;
      }

      .list li {
        padding-bottom: 1.1rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.12);
        animation: fadeUp 0.4s ease both;
      }

      .list li:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      .list .timestamp {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        font-size: 0.82rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: rgba(148, 163, 184, 0.85);
      }

      .list .summary {
        font-size: 1rem;
        line-height: 1.55;
      }

      .topic-pill {
        display: inline-flex;
        align-items: center;
        padding: 0.32rem 0.75rem;
        border-radius: 999px;
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        background: rgba(241, 245, 249, 0.08);
        color: rgba(226, 232, 240, 0.92);
        margin-top: 0.35rem;
      }

      canvas {
        width: 100% !important;
        height: auto !important;
      }

      .tag-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.45rem;
        margin-top: 0.9rem;
      }

      .card-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin-top: 0.65rem;
      }

      .copy-btn {
        border: 1px solid rgba(148, 163, 184, 0.32);
        background: rgba(148, 163, 184, 0.12);
        color: var(--text);
        border-radius: 12px;
        padding: 0.4rem 0.85rem;
        font-size: 0.82rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        cursor: pointer;
        transition: background 0.25s ease, color 0.25s ease, border 0.25s ease;
      }

      .copy-btn:hover,
      .copy-btn.copied {
        background: var(--accent);
        border-color: var(--accent);
        color: #0f172a;
      }

      .toast {
        position: fixed;
        bottom: 2.5rem;
        right: 2.5rem;
        padding: 0.85rem 1.2rem;
        background: var(--panel-strong);
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        color: var(--text);
        font-size: 0.9rem;
        line-height: 1.4;
        opacity: 0;
        pointer-events: none;
        transform: translateY(20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
        box-shadow: var(--panel-glow);
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .tag-group span {
        padding: 0.35rem 0.75rem;
        background: rgba(241, 245, 249, 0.08);
        border-radius: 999px;
        font-size: 0.85rem;
      }

      .notice {
        background: rgba(248, 113, 113, 0.08);
        border: 1px solid rgba(248, 113, 113, 0.2);
        border-radius: 18px;
        padding: 1.35rem 1.5rem;
        color: rgba(248, 250, 252, 0.9);
        line-height: 1.6;
        display: flex;
        gap: 1.1rem;
        margin-top: 2rem;
      }

      .notice strong {
        display: block;
        font-size: 1.05rem;
        margin-bottom: 0.35rem;
      }

      .footer-notes {
        margin-top: 3rem;
        color: var(--text-muted);
        font-size: 0.9rem;
        line-height: 1.6;
        display: grid;
        gap: 0.8rem;
      }

      .footer-notes code {
        font-family: "JetBrains Mono", "Fira Code", monospace;
        background: rgba(15, 23, 42, 0.6);
        padding: 0.2rem 0.45rem;
        border-radius: 6px;
      }

      @media (max-width: 760px) {
        main {
          padding-top: 3rem;
        }

        .summary-panels {
          grid-template-columns: 1fr;
        }

        .two-column {
          grid-template-columns: 1fr;
        }

        .control-bar {
          flex-direction: column;
          align-items: stretch;
        }

        .toast {
          right: 1.5rem;
          left: 1.5rem;
          bottom: 1.5rem;
        }
      }
    </style>
  </head>
  <body data-theme="dark">
    <main>
      <header>
        <div class="header-top">
          <span class="pill" id="status-pill">Booting telemetryâ€¦</span>
          <div class="header-actions">
            <button class="theme-toggle" id="theme-toggle" type="button">ðŸŒ™ Dark mode</button>
          </div>
        </div>
        <h1>Personal Brand Autoposter Â· Command Center</h1>
        <p class="subtitle">
          Live overview of your voice assets, content pipeline, and scheduling cadence. All figures below are derived from the local data artifacts in <code>data/</code>; no account secrets are exposed in the browser.
        </p>
        <div class="meta-strip" id="meta-strip"></div>
      </header>

      <section class="summary-panels" id="summary-cards"></section>

      <div class="section-title">
        <h3>Upcoming cadence</h3>
        <span id="cadence-summary"></span>
      </div>

      <div class="control-bar">
        <div class="control-item">
          <label for="topic-filter">Upcoming filter</label>
          <select id="topic-filter">
            <option value="All">All topics</option>
          </select>
        </div>
        <button class="ghost-button" id="reset-filter" type="button">Reset</button>
      </div>

      <div class="two-column" id="cadence-widgets">
        <article class="panel" id="upcoming-panel"></article>
        <article class="panel">
          <h2>Topics footprint</h2>
          <canvas id="topics-chart" height="240"></canvas>
        </article>
      </div>

      <div class="section-title">
        <h3>Daily volume</h3>
        <span>Distribution across the 30-day window</span>
      </div>
      <article class="panel">
        <canvas id="daily-chart" height="300"></canvas>
      </article>

      <div class="section-title">
        <h3>Voice & system</h3>
        <span id="voice-meta"></span>
      </div>
      <div class="two-column">
        <article class="panel" id="voice-panel"></article>
        <article class="panel" id="insights-panel"></article>
      </div>

      <div class="section-title">
        <h3>Data health</h3>
        <span>Quick diagnostics for next steps</span>
      </div>
      <article class="panel" id="issues-panel"></article>

      <article class="notice">
        <div>âš </div>
        <div>
          <strong>Real usage analytics</strong>
          <p>
            Direct Twitter analytics (impressions, clicks, conversions) require elevated API access. The bundled credentials currently fail authorization, so this dashboard focuses on autoposter artifacts. To ingest live analytics, update the keys in <code>.env</code>, refresh the voice/queue via the CLI, and extend the frontend to hit your preferred analytics provider.
          </p>
        </div>
      </article>

      <section class="footer-notes">
        <div>
          <strong>Serve locally:</strong> <code>python -m http.server 4000</code> â†’ open <code>http://localhost:4000/docs/</code>
        </div>
        <div>
          <strong>Refresh data:</strong> <code>x-autoposter train</code>, <code>x-autoposter schedule --count N --prefer-llm</code>, then reload the browser.
        </div>
        <div>
          <strong>Data sources:</strong> <code>data/voice_profile.json</code>, <code>data/content_plan.json</code>, <code>data/post_queue.json</code>, <code>data/last_schedule.json</code>, and the optional CSV export generated by <code>scripts/train_from_samples.py</code>.
        </div>
      </section>
    </main>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const sources = {
        voice: 'data/voice_profile.json',
        plan: 'data/content_plan.json',
        queue: 'data/post_queue.json',
        schedule: 'data/last_schedule.json',
      };
      const THEME_KEY = 'autoposter-dashboard-theme';
      const toastEl = document.getElementById('toast');
      const filterSelect = document.getElementById('topic-filter');
      const resetFilterBtn = document.getElementById('reset-filter');
      const themeToggle = document.getElementById('theme-toggle');
      let stateCache = null;
      let statsCache = null;
      let activeTopic = 'All';
      let toastTimer = null;
      let topicChart = null;
      let dailyChart = null;

      const fmtDateTime = (value, withTz = true) => {
        if (!value) return 'Not set';
        const dt = new Date(value);
        if (Number.isNaN(dt.getTime())) return value;
        const options = { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' };
        const formatted = dt.toLocaleString(undefined, options);
        if (!withTz) return formatted;
        return `${formatted} ${Intl.DateTimeFormat().resolvedOptions().timeZone}`;
      };

      const fmtDate = (value) => {
        if (!value) return 'Not set';
        const dt = new Date(value);
        if (Number.isNaN(dt.getTime())) return value;
        return dt.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
      };

      const truncate = (text, limit = 160) => {
        if (!text) return 'â€”';
        return text.length > limit ? `${text.slice(0, limit)}â€¦` : text;
      };

      const formatPreview = (text, limit = 160) =>
        truncate(text, limit).replace(/\n/g, '<br />');

      const escapeAttr = (value = '') =>
        value
          .replace(/&/g, '&amp;')
          .replace(/"/g, '&quot;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/'/g, '&#39;')
          .replace(/\r?\n/g, '&#10;');

      const showToast = (message) => {
        if (!toastEl) return;
        toastEl.textContent = message;
        toastEl.classList.add('show');
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => toastEl.classList.remove('show'), 2400);
      };

      const setTheme = (theme) => {
        const next = theme === 'light' ? 'light' : 'dark';
        document.body.dataset.theme = next;
        localStorage.setItem(THEME_KEY, next);
        if (themeToggle) {
          themeToggle.textContent = next === 'dark' ? 'ðŸŒ™ Dark mode' : 'â˜€ï¸ Light mode';
        }
      };

      const toggleTheme = () => {
        const current = document.body.dataset.theme || 'dark';
        const next = current === 'dark' ? 'light' : 'dark';
        setTheme(next);
        showToast(`Switched to ${next} theme`);
        if (statsCache) {
          renderUpcoming(statsCache);
          renderCharts(statsCache);
        }
      };

      const populateTopicFilter = (stats) => {
        if (!filterSelect) return;
        const topics = Array.from(stats.topics.keys());
        filterSelect.innerHTML = ['<option value="All">All topics</option>', ...topics.map((topic) => `<option value="${topic}">${topic}</option>`)].join('');
        if (!topics.includes(activeTopic)) {
          activeTopic = 'All';
        }
        filterSelect.value = activeTopic;
      };

      const bindFilterControls = () => {
        if (filterSelect && !filterSelect.dataset.bound) {
          filterSelect.addEventListener('change', (event) => {
            activeTopic = event.target.value;
            if (statsCache) {
              renderUpcoming(statsCache);
              if (activeTopic !== 'All') {
                showToast(`Filtering by ${activeTopic}`);
              }
            }
          });
          filterSelect.dataset.bound = 'true';
        }

        if (resetFilterBtn && !resetFilterBtn.dataset.bound) {
          resetFilterBtn.addEventListener('click', () => {
            activeTopic = 'All';
            if (filterSelect) filterSelect.value = 'All';
            if (statsCache) renderUpcoming(statsCache);
            showToast('Filters cleared');
          });
          resetFilterBtn.dataset.bound = 'true';
        }
      };

      const bindCopyHandlers = (scope) => {
        const buttons = (scope || document).querySelectorAll('.copy-btn');
        buttons.forEach((btn) => {
          if (btn.dataset.bound) return;
          btn.addEventListener('click', async () => {
            const payload = btn.getAttribute('data-text') || '';
            try {
              await navigator.clipboard.writeText(payload.replace(/&#10;/g, '\n'));
              btn.classList.add('copied');
              showToast('Copied post to clipboard');
              setTimeout(() => btn.classList.remove('copied'), 1200);
            } catch (error) {
              showToast('Clipboard permissions blocked');
            }
          });
          btn.dataset.bound = 'true';
        });
      };

      if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
      }

      setTheme(localStorage.getItem(THEME_KEY) || document.body.dataset.theme || 'dark');

      const fetchState = async () => {
        const state = {};
        await Promise.all(
          Object.entries(sources).map(([key, url]) =>
            fetch(url)
              .then((res) => (res.ok ? res.json() : null))
              .then((data) => {
                state[key] = data;
              })
              .catch(() => {
                state[key] = null;
              }),
          ),
        );
        return state;
      };

      const compute = (state) => {
        const queue = (state.queue || [])
          .map((item) => ({ ...item }))
          .sort((a, b) => new Date(a.scheduled_time) - new Date(b.scheduled_time));
        const plan = state.plan || { posts: [] };
        const firstSlot = queue[0]?.scheduled_time;
        const lastSlot = queue.at(-1)?.scheduled_time;
        const days = [...new Set(queue.map((item) => item.scheduled_time.split('T')[0]))];

        const topics = new Map();
        queue.forEach((item) => {
          const key = item.topic || 'General';
          topics.set(key, (topics.get(key) || 0) + 1);
        });

        const dailyCounts = new Map();
        queue.forEach((item) => {
          const day = item.scheduled_time.split('T')[0];
          dailyCounts.set(day, (dailyCounts.get(day) || 0) + 1);
        });

        const upcoming = queue.slice(0, 9);
        const cadence = days.length ? Math.round(queue.length / days.length) : 0;

        return {
          queue,
          plan,
          firstSlot,
          lastSlot,
          topics,
          dailyCounts,
          upcoming,
          cadence,
          days,
        };
      };

      const renderSummaryCards = (state, stats) => {
        const container = document.querySelector('#summary-cards');
        container.innerHTML = '';
        const cards = [
          {
            title: 'Scheduled posts',
            value: stats.queue.length,
            caption: stats.days.length
              ? `${stats.days.length} days Â· ${stats.cadence}/day`
              : 'Queue empty',
          },
          {
            title: 'Schedule window',
            value: stats.firstSlot ? fmtDate(stats.firstSlot) : 'â€”',
            caption: stats.lastSlot ? `Ends ${fmtDate(stats.lastSlot)}` : 'Run schedule to populate',
          },
          {
            title: 'Content plan',
            value: stats.plan.posts.length,
            caption: state.plan?.generated_at
              ? `Generated ${fmtDateTime(state.plan.generated_at, false)}`
              : 'No plan file',
          },
          {
            title: 'Voice dataset',
            value: state.voice?.metrics?.tweet_count ?? 0,
            caption: state.voice
              ? `Avg length ${Math.round(state.voice.metrics?.avg_length ?? 0)} chars`
              : 'Missing voice profile',
          },
        ];

        cards.forEach((card) => {
          const panel = document.createElement('article');
          panel.className = 'panel';
          panel.innerHTML = `
            <h2>${card.title}</h2>
            <div class="stat">
              <span class="value">${card.value}</span>
              <span class="caption">${card.caption}</span>
            </div>
          `;
          container.appendChild(panel);
        });
      };

      const renderMetaStrip = (state, stats) => {
        const strip = document.querySelector('#meta-strip');
        const refreshed = fmtDateTime(new Date().toISOString());
        const scheduleUpdated = state.schedule?.scheduled_at
          ? fmtDateTime(state.schedule.scheduled_at)
          : 'Not available';
        strip.innerHTML = `
          <span>Refreshed: ${refreshed}</span>
          <span>Last schedule run: ${scheduleUpdated}</span>
          <span>Unique topics: ${stats.topics.size}</span>
        `;
      };

      const renderUpcoming = (stats) => {
        const target = document.querySelector('#upcoming-panel');
        target.innerHTML = '<h2>Next posts</h2>';
        const list = document.createElement('ul');
        list.className = 'list';

        const pool = activeTopic === 'All'
          ? stats.queue
          : stats.queue.filter((item) => (item.topic || 'General') === activeTopic);
        const entries = pool.slice(0, 9);

        if (!entries.length) {
          list.innerHTML = '<li>No posts match the selected filters.</li>';
        } else {
          entries.forEach((item) => {
            const topicLabel = item.topic || 'General';
            const li = document.createElement('li');
            li.innerHTML = `
              <span class="timestamp">${fmtDateTime(item.scheduled_time)}</span>
              <div class="summary">${formatPreview(item.text)}</div>
              <div class="card-footer">
                <div class="topic-pill">${topicLabel}</div>
                <button class="copy-btn" type="button" data-text="${escapeAttr(item.text)}">Copy</button>
              </div>
            `;
            list.appendChild(li);
          });
        }

        target.appendChild(list);
        bindCopyHandlers(list);
      };

      const renderCharts = (stats) => {
        const topicCtx = document.getElementById('topics-chart');
        const dailyCtx = document.getElementById('daily-chart');
        const computedStyle = getComputedStyle(document.body);
        const textColor = (computedStyle.getPropertyValue('--text') || '#f8fafc').trim();
        const mutedColor = (computedStyle.getPropertyValue('--text-muted') || textColor).trim();
        const gridColor = 'rgba(148, 163, 184, 0.12)';

        const topicLabels = Array.from(stats.topics.keys());
        const topicValues = Array.from(stats.topics.values());

        if (topicChart) topicChart.destroy();
        topicChart = new Chart(topicCtx, {
          type: 'doughnut',
          data: {
            labels: topicLabels,
            datasets: [
              {
                data: topicValues,
                backgroundColor: [
                  'rgba(14,165,233,0.7)',
                  'rgba(244,114,182,0.7)',
                  'rgba(163,230,53,0.7)',
                  'rgba(248,113,113,0.7)',
                  'rgba(249,115,22,0.7)',
                  'rgba(196,181,253,0.7)',
                ],
                borderWidth: 0,
              },
            ],
          },
          options: {
            plugins: {
              legend: {
                position: 'bottom',
                labels: { color: mutedColor },
              },
            },
          },
        });

        const dailyLabels = Array.from(stats.dailyCounts.keys()).map((date) =>
          fmtDate(date),
        );
        const dailyValues = Array.from(stats.dailyCounts.values());

        if (dailyChart) dailyChart.destroy();
        dailyChart = new Chart(dailyCtx, {
          type: 'bar',
          data: {
            labels: dailyLabels,
            datasets: [
              {
                label: 'Posts per day',
                data: dailyValues,
                backgroundColor: 'rgba(56,189,248,0.45)',
                borderRadius: 8,
              },
            ],
          },
          options: {
            scales: {
              x: {
                ticks: { color: mutedColor },
                grid: { color: gridColor },
              },
              y: {
                beginAtZero: true,
                ticks: { color: mutedColor, stepSize: 1 },
                grid: { color: gridColor },
              },
            },
            plugins: {
              legend: { display: false },
            },
          },
        });
      };

      const renderVoice = (state) => {
        const panel = document.querySelector('#voice-panel');
        const voice = state.voice;
        if (!voice) {
          panel.innerHTML = '<h2>Voice profile</h2><p>No voice profile found. Run `x-autoposter train`.</p>';
          const meta = document.querySelector('#voice-meta');
          if (meta) meta.textContent = 'No dataset loaded';
          return;
        }

        const tags = (items) =>
          items?.length
            ? items
                .slice(0, 6)
                .map((value) => `<span>${value}</span>`)
                .join('')
            : '<span>None</span>';

          panel.innerHTML = `
          <h2>Voice profile</h2>
          <p>${voice.summary || 'No summary available.'}</p>
          <div class="tag-group">${tags(voice.hashtags)}</div>
          <div class="tag-group">${tags(voice.mentions)}</div>
          <div class="tag-group">${tags(voice.emoji)}</div>
          <h3 style="margin-top:1.6rem;font-size:0.95rem;text-transform:uppercase;letter-spacing:0.14em;color:rgba(148,163,184,0.85);">Example pulls</h3>
          <ul class="list">
            ${(voice.high_performing_examples || [])
              .slice(0, 3)
              .map(
                (item) => `
                <li>
                  <div class="summary">${truncate(item, 180)}</div>
                </li>
              `,
              )
              .join('') || '<li>No examples stored.</li>'}
          </ul>
        `;

        const meta = document.querySelector('#voice-meta');
        if (meta) {
          const avgLength = Math.round(voice.metrics?.avg_length ?? 0);
          meta.textContent = `${voice.metrics?.tweet_count ?? 0} source posts Â· Avg length ${avgLength} chars`;
        }
      };

      const renderInsights = (stats) => {
        const panel = document.querySelector('#insights-panel');
        if (!stats.queue.length) {
          panel.innerHTML = '<h2>Pipeline insights</h2><p>No queue data available.</p>';
          return;
        }

        const firstDay = fmtDate(stats.firstSlot);
        const lastDay = fmtDate(stats.lastSlot);
        const categories = Array.from(stats.topics.entries())
          .map(([topic, count]) => `${topic} (${count})`)
          .join(', ');

        panel.innerHTML = `
          <h2>Pipeline insights</h2>
          <ul class="list">
            <li>
              <span class="summary">Window runs ${firstDay} â†’ ${lastDay}</span>
              <div class="topic-pill">${stats.days.length} days</div>
            </li>
            <li>
              <span class="summary">Average cadence <strong>${stats.cadence}</strong> posts per day</span>
              <div class="topic-pill">${stats.queue.length} total</div>
            </li>
            <li>
              <span class="summary">Topic mix: ${categories}</span>
            </li>
          </ul>
        `;
      };

      const renderIssues = (state, stats) => {
        const panel = document.querySelector('#issues-panel');
        const items = [];

        if (!state.voice) {
          items.push('No voice profile detected. Run `scripts/train_from_samples.py` or `x-autoposter train` to build one.');
        } else if ((state.voice.metrics?.tweet_count ?? 0) === 0) {
          items.push('Voice profile has zero source posts. Twitter API credentials may be invalid.');
        }

        if (!stats.queue.length) {
          items.push('Queue empty. Schedule a plan to keep the pipeline active.');
        } else {
          const coverage = stats.days.length >= 30 ? 'âœ“ 30-day runway secured.' : `Only ${stats.days.length} days scheduled.`;
          items.push(coverage);
        }

        if (!state.schedule?.scheduled_at) {
          items.push('`data/last_schedule.json` missing. Run scheduling CLI to refresh metadata.');
        }

        panel.innerHTML = `
          <div class="list">
            ${items.map((item) => `<li>${item}</li>`).join('')}
          </div>
        `;
      };

      const updateStatusPill = (state, stats) => {
        const pill = document.querySelector('#status-pill');
        const hasVoice = !!state.voice && (state.voice.metrics?.tweet_count ?? 0) > 0;
        const hasQueue = stats.queue.length > 0;
        if (hasVoice && hasQueue) {
          pill.textContent = 'Automation ready';
          pill.style.background = 'rgba(34,197,94,0.15)';
          pill.style.borderColor = 'rgba(34,197,94,0.35)';
          pill.style.color = 'var(--success)';
        } else if (hasVoice || hasQueue) {
          pill.textContent = 'Partial setup';
          pill.style.background = 'rgba(249,115,22,0.15)';
          pill.style.borderColor = 'rgba(249,115,22,0.35)';
          pill.style.color = 'var(--warning)';
        } else {
          pill.textContent = 'Action required';
          pill.style.background = 'rgba(248,113,113,0.18)';
          pill.style.borderColor = 'rgba(248,113,113,0.38)';
          pill.style.color = 'var(--danger)';
        }
      };

      (async () => {
        const state = await fetchState();
        const stats = compute(state);
        stateCache = state;
        statsCache = stats;
        populateTopicFilter(stats);
        bindFilterControls();
        renderSummaryCards(state, stats);
        renderMetaStrip(state, stats);
        renderUpcoming(stats);
        renderCharts(stats);
        renderVoice(state);
        renderInsights(stats);
        renderIssues(state, stats);
        updateStatusPill(state, stats);
        const cadenceCopy = stats.days.length
          ? `${stats.queue.length} posts scheduled â€¢ ${stats.days.length} days â€¢ ${stats.cadence}/day`
          : 'No active schedule';
        document.querySelector('#cadence-summary').textContent = cadenceCopy;
      })();
    </script>
  </body>
</html>
