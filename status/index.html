<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Autoposter Command Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light dark;
        --bg: radial-gradient(circle at top left, #1e293b 0%, #020617 45%, #000510 100%);
        --panel: rgba(15, 23, 42, 0.78);
        --panel-strong: rgba(15, 23, 42, 0.92);
        --panel-border: rgba(148, 163, 184, 0.14);
        --text: #f8fafc;
        --text-muted: rgba(203, 213, 225, 0.85);
        --accent: #38bdf8;
        --accent-strong: #0ea5e9;
        --accent-soft: rgba(56, 189, 248, 0.18);
        --warning: #f97316;
        --danger: #f87171;
        --success: #22c55e;
        --panel-glow: 0 40px 80px rgba(15, 23, 42, 0.55);
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        color: var(--text);
        display: flex;
        justify-content: center;
      }

      main {
        width: min(1200px, 94vw);
        padding: 4rem 0 6rem 0;
      }

      header {
        display: flex;
        flex-direction: column;
        gap: 0.9rem;
        margin-bottom: 2.5rem;
        position: relative;
      }

      header::after {
        content: "";
        position: absolute;
        inset: -40% auto auto -20%;
        width: 420px;
        height: 420px;
        background: radial-gradient(circle, rgba(14, 165, 233, 0.28) 0%, rgba(2, 6, 23, 0) 70%);
        filter: blur(20px);
        pointer-events: none;
        z-index: -1;
      }

      .pill {
        align-self: flex-start;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.45rem 0.9rem;
        border-radius: 999px;
        background: rgba(14, 165, 233, 0.12);
        border: 1px solid rgba(56, 189, 248, 0.25);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        font-size: 0.78rem;
        color: var(--accent);
      }

      h1 {
        margin: 0;
        font-size: clamp(2.2rem, 6vw, 3.2rem);
        font-weight: 800;
        letter-spacing: -0.035em;
      }

      .subtitle {
        color: var(--text-muted);
        max-width: 80ch;
        line-height: 1.65;
        font-size: 1.04rem;
      }

      .meta-strip {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      .panel-grid {
        display: grid;
        gap: 1.6rem;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      }

      .panel {
        background: var(--panel);
        border-radius: 22px;
        padding: 1.9rem;
        border: 1px solid var(--panel-border);
        box-shadow: var(--panel-glow);
        backdrop-filter: blur(16px);
      }

      .panel h2 {
        margin: 0 0 0.75rem 0;
        font-size: 1rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.9);
      }

      .stat {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .stat .value {
        font-size: 2.6rem;
        font-weight: 700;
      }

      .stat .caption {
        font-size: 0.95rem;
        color: var(--text-muted);
      }

      .summary-panels {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.4rem;
        margin-bottom: 2.4rem;
      }

      .summary-panels .panel {
        position: relative;
        overflow: hidden;
      }

      .summary-panels .panel::after {
        content: "";
        position: absolute;
        inset: -30% -45% auto auto;
        width: 180px;
        height: 180px;
        background: radial-gradient(circle, rgba(56, 189, 248, 0.16) 0%, rgba(56, 189, 248, 0) 70%);
        pointer-events: none;
      }

      .section-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin: 3rem 0 1.4rem 0;
      }

      .section-title h3 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 700;
        letter-spacing: -0.01em;
      }

      .section-title span {
        color: var(--text-muted);
        font-size: 0.95rem;
      }

      .two-column {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.6rem;
      }

      .list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 1.1rem;
      }

      .list li {
        padding-bottom: 1.1rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.12);
      }

      .list li:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      .list .timestamp {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        font-size: 0.82rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: rgba(148, 163, 184, 0.85);
      }

      .list .summary {
        font-size: 1rem;
        line-height: 1.55;
      }

      .topic-pill {
        display: inline-flex;
        align-items: center;
        padding: 0.32rem 0.75rem;
        border-radius: 999px;
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        background: rgba(241, 245, 249, 0.08);
        color: rgba(226, 232, 240, 0.92);
        margin-top: 0.35rem;
      }

      canvas {
        width: 100% !important;
        height: auto !important;
      }

      .tag-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.45rem;
        margin-top: 0.9rem;
      }

      .tag-group span {
        padding: 0.35rem 0.75rem;
        background: rgba(241, 245, 249, 0.08);
        border-radius: 999px;
        font-size: 0.85rem;
      }

      .notice {
        background: rgba(248, 113, 113, 0.08);
        border: 1px solid rgba(248, 113, 113, 0.2);
        border-radius: 18px;
        padding: 1.35rem 1.5rem;
        color: rgba(248, 250, 252, 0.9);
        line-height: 1.6;
        display: flex;
        gap: 1.1rem;
        margin-top: 2rem;
      }

      .notice strong {
        display: block;
        font-size: 1.05rem;
        margin-bottom: 0.35rem;
      }

      .footer-notes {
        margin-top: 3rem;
        color: var(--text-muted);
        font-size: 0.9rem;
        line-height: 1.6;
        display: grid;
        gap: 0.8rem;
      }

      .footer-notes code {
        font-family: "JetBrains Mono", "Fira Code", monospace;
        background: rgba(15, 23, 42, 0.6);
        padding: 0.2rem 0.45rem;
        border-radius: 6px;
      }

      @media (max-width: 760px) {
        main {
          padding-top: 3rem;
        }

        .summary-panels {
          grid-template-columns: 1fr;
        }

        .two-column {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <span class="pill" id="status-pill">Booting telemetry…</span>
        <h1>Personal Brand Autoposter · Command Center</h1>
        <p class="subtitle">
          Live overview of your voice assets, content pipeline, and scheduling cadence. All figures below are derived from the local data artifacts in <code>data/</code>; no account secrets are exposed in the browser.
        </p>
        <div class="meta-strip" id="meta-strip"></div>
      </header>

      <section class="summary-panels" id="summary-cards"></section>

      <div class="section-title">
        <h3>Upcoming cadence</h3>
        <span id="cadence-summary"></span>
      </div>

      <div class="two-column" id="cadence-widgets">
        <article class="panel" id="upcoming-panel"></article>
        <article class="panel">
          <h2>Topics footprint</h2>
          <canvas id="topics-chart" height="240"></canvas>
        </article>
      </div>

      <div class="section-title">
        <h3>Daily volume</h3>
        <span>Distribution across the 30-day window</span>
      </div>
      <article class="panel">
        <canvas id="daily-chart" height="300"></canvas>
      </article>

      <div class="section-title">
        <h3>Voice & system</h3>
        <span id="voice-meta"></span>
      </div>
      <div class="two-column">
        <article class="panel" id="voice-panel"></article>
        <article class="panel" id="insights-panel"></article>
      </div>

      <div class="section-title">
        <h3>Data health</h3>
        <span>Quick diagnostics for next steps</span>
      </div>
      <article class="panel" id="issues-panel"></article>

      <article class="notice">
        <div>⚠</div>
        <div>
          <strong>Real usage analytics</strong>
          <p>
            Direct Twitter analytics (impressions, clicks, conversions) require elevated API access. The bundled credentials currently fail authorization, so this dashboard focuses on autoposter artifacts. To ingest live analytics, update the keys in <code>.env</code>, refresh the voice/queue via the CLI, and extend the frontend to hit your preferred analytics provider.
          </p>
        </div>
      </article>

      <section class="footer-notes">
        <div>
          <strong>Serve locally:</strong> <code>python -m http.server 4000</code> → open <code>http://localhost:4000/status/</code>
        </div>
        <div>
          <strong>Refresh data:</strong> <code>x-autoposter train</code>, <code>x-autoposter schedule --count N --prefer-llm</code>, then reload the browser.
        </div>
        <div>
          <strong>Data sources:</strong> <code>data/voice_profile.json</code>, <code>data/content_plan.json</code>, <code>data/post_queue.json</code>, <code>data/last_schedule.json</code>, and the optional CSV export generated by <code>scripts/train_from_samples.py</code>.
        </div>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const sources = {
        voice: 'data/voice_profile.json',
        plan: 'data/content_plan.json',
        queue: 'data/post_queue.json',
        schedule: 'data/last_schedule.json',
      };

      const fmtDateTime = (value, withTz = true) => {
        if (!value) return 'Not set';
        const dt = new Date(value);
        if (Number.isNaN(dt.getTime())) return value;
        const options = { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' };
        const formatted = dt.toLocaleString(undefined, options);
        if (!withTz) return formatted;
        return `${formatted} ${Intl.DateTimeFormat().resolvedOptions().timeZone}`;
      };

      const fmtDate = (value) => {
        if (!value) return 'Not set';
        const dt = new Date(value);
        if (Number.isNaN(dt.getTime())) return value;
        return dt.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
      };

      const truncate = (text, limit = 160) => {
        if (!text) return '—';
        return text.length > limit ? `${text.slice(0, limit)}…` : text;
      };

      const fetchState = async () => {
        const state = {};
        await Promise.all(
          Object.entries(sources).map(([key, url]) =>
            fetch(url)
              .then((res) => (res.ok ? res.json() : null))
              .then((data) => {
                state[key] = data;
              })
              .catch(() => {
                state[key] = null;
              }),
          ),
        );
        return state;
      };

      const compute = (state) => {
        const queue = state.queue || [];
        const plan = state.plan || { posts: [] };
        const firstSlot = queue[0]?.scheduled_time;
        const lastSlot = queue.at(-1)?.scheduled_time;
        const days = [...new Set(queue.map((item) => item.scheduled_time.split('T')[0]))];

        const topics = new Map();
        queue.forEach((item) => {
          const key = item.topic || 'General';
          topics.set(key, (topics.get(key) || 0) + 1);
        });

        const dailyCounts = new Map();
        queue.forEach((item) => {
          const day = item.scheduled_time.split('T')[0];
          dailyCounts.set(day, (dailyCounts.get(day) || 0) + 1);
        });

        const upcoming = queue.slice(0, 9);
        const cadence = days.length ? Math.round(queue.length / days.length) : 0;

        return {
          queue,
          plan,
          firstSlot,
          lastSlot,
          topics,
          dailyCounts,
          upcoming,
          cadence,
          days,
        };
      };

      const renderSummaryCards = (state, stats) => {
        const container = document.querySelector('#summary-cards');
        container.innerHTML = '';
        const cards = [
          {
            title: 'Scheduled posts',
            value: stats.queue.length,
            caption: stats.days.length
              ? `${stats.days.length} days · ${stats.cadence}/day`
              : 'Queue empty',
          },
          {
            title: 'Schedule window',
            value: stats.firstSlot ? fmtDate(stats.firstSlot) : '—',
            caption: stats.lastSlot ? `Ends ${fmtDate(stats.lastSlot)}` : 'Run schedule to populate',
          },
          {
            title: 'Content plan',
            value: stats.plan.posts.length,
            caption: state.plan?.generated_at
              ? `Generated ${fmtDateTime(state.plan.generated_at, false)}`
              : 'No plan file',
          },
          {
            title: 'Voice dataset',
            value: state.voice?.metrics?.tweet_count ?? 0,
            caption: state.voice
              ? `Avg length ${Math.round(state.voice.metrics?.avg_length ?? 0)} chars`
              : 'Missing voice profile',
          },
        ];

        cards.forEach((card) => {
          const panel = document.createElement('article');
          panel.className = 'panel';
          panel.innerHTML = `
            <h2>${card.title}</h2>
            <div class="stat">
              <span class="value">${card.value}</span>
              <span class="caption">${card.caption}</span>
            </div>
          `;
          container.appendChild(panel);
        });
      };

      const renderMetaStrip = (state, stats) => {
        const strip = document.querySelector('#meta-strip');
        const refreshed = fmtDateTime(new Date().toISOString());
        const scheduleUpdated = state.schedule?.scheduled_at
          ? fmtDateTime(state.schedule.scheduled_at)
          : 'Not available';
        strip.innerHTML = `
          <span>Refreshed: ${refreshed}</span>
          <span>Last schedule run: ${scheduleUpdated}</span>
          <span>Unique topics: ${stats.topics.size}</span>
        `;
      };

      const renderUpcoming = (stats) => {
        const target = document.querySelector('#upcoming-panel');
        target.innerHTML = '<h2>Next 9 posts</h2>';
        const list = document.createElement('ul');
        list.className = 'list';

        if (!stats.upcoming.length) {
          list.innerHTML = '<li>No posts queued. Schedule to preview upcoming copy.</li>';
        } else {
          stats.upcoming.forEach((item) => {
            const li = document.createElement('li');
            li.innerHTML = `
              <span class="timestamp">${fmtDateTime(item.scheduled_time)}</span>
              <div class="summary">${truncate(item.text)}</div>
              <div class="topic-pill">${item.topic || 'General'}</div>
            `;
            list.appendChild(li);
          });
        }

        target.appendChild(list);
      };

      const renderCharts = (stats) => {
        const topicCtx = document.getElementById('topics-chart');
        const dailyCtx = document.getElementById('daily-chart');

        const topicLabels = Array.from(stats.topics.keys());
        const topicValues = Array.from(stats.topics.values());

        new Chart(topicCtx, {
          type: 'doughnut',
          data: {
            labels: topicLabels,
            datasets: [
              {
                data: topicValues,
                backgroundColor: [
                  'rgba(14,165,233,0.7)',
                  'rgba(244,114,182,0.7)',
                  'rgba(163,230,53,0.7)',
                  'rgba(248,113,113,0.7)',
                  'rgba(249,115,22,0.7)',
                  'rgba(196,181,253,0.7)',
                ],
                borderWidth: 0,
              },
            ],
          },
          options: {
            plugins: {
              legend: {
                position: 'bottom',
                labels: { color: 'rgba(241,245,249,0.9)' },
              },
            },
          },
        });

        const dailyLabels = Array.from(stats.dailyCounts.keys()).map((date) =>
          fmtDate(date),
        );
        const dailyValues = Array.from(stats.dailyCounts.values());

        new Chart(dailyCtx, {
          type: 'bar',
          data: {
            labels: dailyLabels,
            datasets: [
              {
                label: 'Posts per day',
                data: dailyValues,
                backgroundColor: 'rgba(56,189,248,0.45)',
                borderRadius: 8,
              },
            ],
          },
          options: {
            scales: {
              x: {
                ticks: { color: 'rgba(226,232,240,0.8)' },
                grid: { color: 'rgba(148,163,184,0.08)' },
              },
              y: {
                beginAtZero: true,
                ticks: { color: 'rgba(226,232,240,0.8)', stepSize: 1 },
                grid: { color: 'rgba(148,163,184,0.08)' },
              },
            },
            plugins: {
              legend: { display: false },
            },
          },
        });
      };

      const renderVoice = (state) => {
        const panel = document.querySelector('#voice-panel');
        const voice = state.voice;
        if (!voice) {
          panel.innerHTML = '<h2>Voice profile</h2><p>No voice profile found. Run `x-autoposter train`.</p>';
          return;
        }

        const tags = (items) =>
          items?.length
            ? items
                .slice(0, 6)
                .map((value) => `<span>${value}</span>`)
                .join('')
            : '<span>None</span>';

        panel.innerHTML = `
          <h2>Voice profile</h2>
          <p>${voice.summary || 'No summary available.'}</p>
          <div class="tag-group">${tags(voice.hashtags)}</div>
          <div class="tag-group">${tags(voice.mentions)}</div>
          <div class="tag-group">${tags(voice.emoji)}</div>
          <h3 style="margin-top:1.6rem;font-size:0.95rem;text-transform:uppercase;letter-spacing:0.14em;color:rgba(148,163,184,0.85);">Example pulls</h3>
          <ul class="list">
            ${(voice.high_performing_examples || [])
              .slice(0, 3)
              .map(
                (item) => `
                <li>
                  <div class="summary">${truncate(item, 180)}</div>
                </li>
              `,
              )
              .join('') || '<li>No examples stored.</li>'}
          </ul>
        `;
      };

      const renderInsights = (stats) => {
        const panel = document.querySelector('#insights-panel');
        if (!stats.queue.length) {
          panel.innerHTML = '<h2>Pipeline insights</h2><p>No queue data available.</p>';
          return;
        }

        const firstDay = fmtDate(stats.firstSlot);
        const lastDay = fmtDate(stats.lastSlot);
        const categories = Array.from(stats.topics.entries())
          .map(([topic, count]) => `${topic} (${count})`)
          .join(', ');

        panel.innerHTML = `
          <h2>Pipeline insights</h2>
          <ul class="list">
            <li>
              <span class="summary">Window runs ${firstDay} → ${lastDay}</span>
              <div class="topic-pill">${stats.days.length} days</div>
            </li>
            <li>
              <span class="summary">Average cadence <strong>${stats.cadence}</strong> posts per day</span>
              <div class="topic-pill">${stats.queue.length} total</div>
            </li>
            <li>
              <span class="summary">Topic mix: ${categories}</span>
            </li>
          </ul>
        `;
      };

      const renderIssues = (state, stats) => {
        const panel = document.querySelector('#issues-panel');
        const items = [];

        if (!state.voice) {
          items.push('No voice profile detected. Run `scripts/train_from_samples.py` or `x-autoposter train` to build one.');
        } else if ((state.voice.metrics?.tweet_count ?? 0) === 0) {
          items.push('Voice profile has zero source posts. Twitter API credentials may be invalid.');
        }

        if (!stats.queue.length) {
          items.push('Queue empty. Schedule a plan to keep the pipeline active.');
        } else {
          const coverage = stats.days.length >= 30 ? '✓ 30-day runway secured.' : `Only ${stats.days.length} days scheduled.`;
          items.push(coverage);
        }

        if (!state.schedule?.scheduled_at) {
          items.push('`data/last_schedule.json` missing. Run scheduling CLI to refresh metadata.');
        }

        panel.innerHTML = `
          <div class="list">
            ${items.map((item) => `<li>${item}</li>`).join('')}
          </div>
        `;
      };

      const updateStatusPill = (state, stats) => {
        const pill = document.querySelector('#status-pill');
        const hasVoice = !!state.voice && (state.voice.metrics?.tweet_count ?? 0) > 0;
        const hasQueue = stats.queue.length > 0;
        if (hasVoice && hasQueue) {
          pill.textContent = 'Automation ready';
          pill.style.background = 'rgba(34,197,94,0.15)';
          pill.style.borderColor = 'rgba(34,197,94,0.35)';
          pill.style.color = 'var(--success)';
        } else if (hasVoice || hasQueue) {
          pill.textContent = 'Partial setup';
          pill.style.background = 'rgba(249,115,22,0.15)';
          pill.style.borderColor = 'rgba(249,115,22,0.35)';
          pill.style.color = 'var(--warning)';
        } else {
          pill.textContent = 'Action required';
          pill.style.background = 'rgba(248,113,113,0.18)';
          pill.style.borderColor = 'rgba(248,113,113,0.38)';
          pill.style.color = 'var(--danger)';
        }
      };

      (async () => {
        const state = await fetchState();
        const stats = compute(state);
        renderSummaryCards(state, stats);
        renderMetaStrip(state, stats);
        renderUpcoming(stats);
        renderCharts(stats);
        renderVoice(state);
        renderInsights(stats);
        renderIssues(state, stats);
        updateStatusPill(state, stats);
        const cadenceCopy = stats.days.length
          ? `${stats.queue.length} posts scheduled • ${stats.days.length} days • ${stats.cadence}/day`
          : 'No active schedule';
        document.querySelector('#cadence-summary').textContent = cadenceCopy;
      })();
    </script>
  </body>
</html>
